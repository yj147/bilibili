# Component Guidelines

> Component patterns and conventions in Bili-Sentinel frontend.

---

## Component Categories

### 1. Page Components (`app/{feature}/page.tsx`)
- Always `"use client"` (SWR requires client rendering)
- Fetch data with SWR hooks, mutate with api client

### 2. Shared Components (`components/`)
- Reusable across pages: `BentoCard`, `StatItem`, `Sidebar`, `ErrorBoundary`

### 3. UI Primitives (`components/ui/`)
- Generated by shadcn/ui CLI, Radix UI based
- Do not modify directly

---

## Styling Conventions

### Design System
- **Theme**: Dark mode only (`bg-black text-white`)
- **Glass cards**: `glass-card` CSS class (backdrop-blur + border)
- **Colors**: Blue-500 accent, Green success, Red failure, Purple secondary
- **Animations**: Framer Motion for enter/exit, CSS for ongoing
- **Typography**: Geist Sans + Geist Mono

### Tailwind Patterns
```tsx
// Glass card
<div className="glass-card p-6 rounded-3xl border-white/5">

// Status indicator
<div className={`w-2 h-2 rounded-full ${isActive ? 'bg-green-500' : 'bg-red-500'}`} />

// Use cn() for conditional classes
import { cn } from "@/lib/utils";
<div className={cn("base", isActive && "active")} />
```

### Responsive Design
- Mobile-first with `md:` breakpoint
- Sidebar: hidden mobile, fixed 64px desktop
- Main content: `md:ml-64` offset
- Grids: `grid-cols-1 md:grid-cols-4`

---

## Animation Patterns

### Framer Motion
```tsx
<motion.div initial={{ height: 0 }} animate={{ height: `${v}%` }} transition={{ delay: i * 0.05 }} />
```

### CSS Animations
```tsx
<span className="animate-pulse" />           // Active indicators
<RefreshCw className={loading ? "animate-spin" : ""} />  // Loading
```

---

## Common Mistakes

1. **Forgetting "use client"** — SWR hooks require it
2. **Modifying shadcn/ui files directly** — customize via className props
3. **Using Server Components for interactive pages** — all feature pages are client components

---

## Toast Notification Pattern

Use `Toast` component (`components/Toast.tsx`) for transient user notifications:

```tsx
import { createToast, ToastContainer } from "@/components/Toast";

const [toasts, setToasts] = useState<Toast[]>([]);
createToast(setToasts, "warning", "账号 Cookie 即将过期");

<ToastContainer toasts={toasts} onDismiss={(id) => setToasts(t => t.filter(x => x.id !== id))} />
```

### Toast Deduplication via useRef

Prevent duplicate toasts on SWR re-render using a `Set` ref:

```tsx
const notifiedRef = useRef(new Set<number>());

useEffect(() => {
  accounts?.forEach(acc => {
    if (acc.status === "expiring" && !notifiedRef.current.has(acc.id)) {
      notifiedRef.current.add(acc.id);
      createToast(setToasts, "warning", `账号 ${acc.name} Cookie 即将过期`);
    }
  });
}, [accounts]);
```

**Why**: SWR triggers re-renders on revalidation. Without dedup, the same toast fires repeatedly.

---

## QR Login Modal Pattern

QR login is a multi-step flow with state machine:

| State | Display |
|-------|--------|
| `loading` | Spinner |
| `waiting` | QR code image |
| `scanned` | "已扫码，请确认" |
| `success` | Green checkmark, auto-close |
| `expired` | "已过期" + refresh button |
| `error` | Error message + retry |

**Key**: The modal is conditionally rendered (not hidden via CSS), so mount/unmount triggers cleanup of polling intervals.

---

## Edit Modal Pattern

CRUD pages follow a consistent pattern for edit modals:

```tsx
const [editingItem, setEditingItem] = useState<Item | null>(null);
const [editForm, setEditForm] = useState({ field1: '', field2: '' });

// Open modal with pre-filled data
const handleEdit = (item: Item) => {
  setEditForm({ field1: item.field1, field2: item.field2 });
  setEditingItem(item);
};

// Save and close
const handleSave = async () => {
  await api.items.update(editingItem!.id, editForm);
  mutate(); // SWR revalidation
  setEditingItem(null);
};

// AnimatePresence for enter/exit animation
{editingItem && (
  <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
    {/* Modal content */}
  </motion.div>
)}
```

---

## Mobile-Friendly Action Buttons

Action buttons that appear on hover must remain visible on touch devices:

```tsx
// Good — visible on mobile, hover-reveal on desktop
<div className="opacity-100 md:opacity-0 md:group-hover:opacity-100 transition">
  <button>Edit</button>
  <button>Delete</button>
</div>

// Bad — invisible on mobile
<div className="opacity-0 group-hover:opacity-100">
```

---

## WebSocket Development Mode

The WebSocket hook connects directly to the backend in development, bypassing the Next.js proxy (which does not support WebSocket upgrade):

```typescript
const isDev = process.env.NODE_ENV === 'development';
const wsUrl = process.env.NEXT_PUBLIC_WS_URL
  || (isDev ? 'ws://localhost:8000' : `${protocol}//${window.location.host}`);
```

In production (behind a reverse proxy that handles WS), it uses the page host.
